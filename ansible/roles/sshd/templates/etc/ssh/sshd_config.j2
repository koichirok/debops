{# Copyright (C) 2023 Maciej Delmanowski <drybjed@gmail.com>
 # Copyright (C) 2023 DebOps <https://debops.org/>
 # SPDX-License-Identifier: GPL-3.0-only
 #}
# {{ ansible_managed }}

{% for element in sshd__combined_configuration | debops.debops.parse_kv_config %}
{%   if element.name | d() == 'Header Comment' and element.state | d('present') %}
{%     if element.raw | d() %}
{{ element.raw }}
{%     endif %}
{%   endif %}
{% endfor %}

{% for element in sshd__combined_configuration | debops.debops.parse_kv_config %}
{%   if element.name | d() and element.name != 'Header Comment' and element.state | d('present') not in [ 'absent', 'ignore' ] %}
{%     set element_comment = ('#' if (element.state | d('present') in [ 'init', 'comment' ]) else '') %}
{%     set element_name = (element.option | d(element.name)) %}
{%     set element_delimiter = (element.delimiter | d(' ')) %}
{%     if element.value is defined %}
{%       if element.value is string and not element.value | bool %}
{%         set element_value = element.value %}
{%       elif element.value | bool and element.value is not iterable %}
{%         if element.value | string == '1' %}
{%           set element_value = element.value %}
{%         else %}
{%           set element_value = 'yes' %}
{%         endif %}
{%       elif not element.value | bool and element.value is not iterable %}
{%         if element.value is not none %}
{%           if element.value | int %}
{%             set element_value = element.value %}
{%           else %}
{%             if element.value | string == '0' %}
{%               set element_value = element.value %}
{%             else %}
{%               set element_value = 'no' %}
{%             endif %}
{%           endif %}
{%         endif %}
{%       else %}
{%         set element_value = element.value | map(attribute='name') | list | join(' ') %}
{%       endif %}
{%     endif %}
{%     if element.separator | d() | bool %}
{{       '' }}
{%     endif %}
{%     if element.comment | d() %}
{%       if element.comment_separator | d(true) %}
{{       '' }}
{%       endif %}
{{       element.comment | regex_replace('\n$', '') | comment(prefix='', postfix='') -}}
{%       if element.comment_after_separator | d() %}
{{       '' }}
{%       endif %}
{%     endif %}
{%     if element.raw | d() %}
{%       if element.state == 'comment' %}
{{         element.raw | regex_replace('\n$', '') | comment(decoration='#', prefix='', postfix='') -}}
{%       else %}
{{         element.raw | regex_replace('\n$', '') -}}
{%       endif %}
{%     else %}
{{       '{}{}{}{}'.format(element_comment, element_name, element_delimiter, element_value) -}}
{%       if element.config | d() %}
{{ '' }}
{%         if element.state == 'comment' %}
{{           element.config | regex_replace('\n$', '') | indent(element.indent | d(8), true) | comment(decoration='#', prefix='', postfix='') -}}
{%         else %}
{{           element.config | regex_replace('\n$', '') | indent(element.indent | d(8), true) -}}
{%         endif %}
{%       endif %}
{%     endif %}
{%     if not loop.last %}
{{ ''}}
{%     endif %}
{%   endif %}
{% endfor %}
